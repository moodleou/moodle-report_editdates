{"version":3,"file":"datehelper.min.js","sources":["../src/datehelper.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD module to help editing course dates\n *\n * @module     report_editdates/datehelper\n * @copyright  2022 Te Wānanga o Aotearoa\n */\n\nimport * as ModalFactory from 'core/modal_factory';\nimport {get_string as getString} from 'core/str';\n\nconst classOutOfRange = \"outofrange\";\nconst farawayDate = \"December 31, 2099 23:59:59\";\nlet datetimeSelectors = {};\nlet startDate = {};\nlet endDate = new Date(farawayDate);\n\n/**\n * Initialiser function.\n */\nexport const init = () => {\n    // Give our variables values.\n    datetimeSelectors = document.querySelectorAll(\"div[data-fieldtype='date_time_selector']\");\n    let courseStart = datetimeSelectors.item(0);\n    let courseEnd = datetimeSelectors.item(1);\n    startDate = getDate(courseStart);\n    let optional = courseEnd.querySelector(\"input[type='checkbox']\");\n    if (optional.checked) {\n        endDate = getDate(courseEnd);\n    }\n\n    // Add some event Listeners.\n    courseStart.addEventListener(\"change\", startDateChanged);\n    courseEnd.addEventListener(\"change\", endDateChanged);\n    // Activity module date time selector events.\n    for (const date of datetimeSelectors.entries()) {\n        if (date[0] > 1) {\n            date[1].addEventListener(\"change\", modDateChanged);\n        }\n    }\n    // Date picker event.\n    M.form.dateselector.calendar.on('selectionChange', updateDates, false);\n};\n\n/**\n * A date has been changed using the date selector calendar.\n */\nconst updateDates = () => {\n    let datepicker = M.form.dateselector.currentowner;\n    if (null === datepicker) {\n        return;\n    }\n    // Todo: is there a better way to ensure this runs after the selects have been updated?\n    setTimeout(\n        function() {\n            let el = datepicker.calendarimage.getDOMNode();\n            let datetimeSelector = el.closest(\"div[data-fieldtype='date_time_selector']\");\n            if (datetimeSelector === datetimeSelectors.item(0)) {\n                startDateChanged();\n            } else if (datetimeSelector === datetimeSelectors.item(1)) {\n                endDateChanged();\n            } else {\n                checkDateRange(datetimeSelector);\n            }\n        },\n        100\n    );\n};\n\n/**\n * The start date of the course has been changed.\n * Adjust all other dates accordingly if desired.\n */\nconst startDateChanged = () => {\n    startDate = adjustDates();\n    checkAllDatesRange();\n};\n\n/**\n * The end date of the course has been changed.\n * Check if any activity module dates are after this date.\n */\nconst endDateChanged = () => {\n    let endDateSelector = datetimeSelectors.item(1);\n    let optional = endDateSelector.querySelector(\"input[type='checkbox']\");\n    if (optional.checked) {\n        endDate = getDate(endDateSelector);\n    } else {\n        endDate = new Date(farawayDate);\n    }\n    checkAllDatesRange();\n};\n\n/**\n * An activity module date has been changed.\n * Check and warn if it is now after the course end date.\n * @param {Event} ev\n */\nconst modDateChanged = (ev) => {\n    // Check against course end date.\n    let container = ev.target.closest(\"div[data-fieldtype='date_time_selector']\");\n\n    checkDateRange(container);\n};\n\n/**\n * Get a Date object from the select DOM elements.\n * @param {HTMLElement} dateEl\n * @returns {Date}\n */\nconst getDate = (dateEl) => {\n    let year = dateEl.querySelector(\".fdate_time_selector > div:nth-child(3) select\");\n    let month = dateEl.querySelector(\".fdate_time_selector > div:nth-child(2) select\");\n    let day = dateEl.querySelector(\".fdate_time_selector > div:nth-child(1) select\");\n    let hour = dateEl.querySelector(\".fdate_time_selector > div:nth-child(4) select\");\n    let minute = dateEl.querySelector(\".fdate_time_selector > div:nth-child(5) select\");\n    return new Date(\n        year.options[year.selectedIndex].value,\n        month.options[month.selectedIndex].value - 1,\n        day.options[day.selectedIndex].value,\n        hour.options[hour.selectedIndex].value,\n        minute.options[minute.selectedIndex].value,\n    );\n};\n\n/**\n * Update the select DOM elements with a given Date object.\n * @param {HTMLElement} dateEl\n * @param {Date} date\n */\nconst setDate = (dateEl, date) => {\n    let year = dateEl.querySelector(\".fdate_time_selector > div:nth-child(3) select\");\n    let month = dateEl.querySelector(\".fdate_time_selector > div:nth-child(2) select\");\n    let day = dateEl.querySelector(\".fdate_time_selector > div:nth-child(1) select\");\n    let hour = dateEl.querySelector(\".fdate_time_selector > div:nth-child(4) select\");\n    let minute = dateEl.querySelector(\".fdate_time_selector > div:nth-child(5) select\");\n    year.querySelector(\"[value='\" + date.getFullYear() + \"']\").selected = \"selected\";\n    month.querySelector(\"[value='\" + (date.getMonth() + 1) + \"']\").selected = \"selected\";\n    day.querySelector(\"[value='\" + date.getDate() + \"']\").selected = \"selected\";\n    hour.querySelector(\"[value='\" + date.getHours() + \"']\").selected = \"selected\";\n    minute.querySelector(\"[value='\" + date.getMinutes() + \"']\").selected = \"selected\";\n};\n\n/**\n * Check if the date change has caused any dates to be outside the course start and end.\n * @returns {boolean|*}\n */\nconst checkAllDatesRange = () => {\n    let datesOutOfRange = 0;\n    // Loop dates and if they are enabled then check the date range.\n    for (const date of datetimeSelectors.entries()) {\n        if (date[0] > 1) {\n            let optional = date[1].querySelector(\"input[type='checkbox']\");\n            if (optional === null || optional.checked) {\n                datesOutOfRange += checkDateRange(date[1]);\n            }\n        }\n    }\n\n    // Warn the person about it.\n    if (datesOutOfRange > 0) {\n        return ModalFactory.create({\n            type: ModalFactory.types.DEFAULT,\n            title: getString('datesoutofrange_title', 'report_editdates'),\n            body: getString('datesoutofrange_body', 'report_editdates')\n        })\n            .then(modal => {\n                modal.show();\n                return modal;\n            });\n    }\n\n    return false;\n};\n\n/**\n * Compare the date with the course end date. Toggle CSS class of element.\n * @param {HTMLElement} el\n * @returns {boolean}\n */\nconst checkDateRange = (el) => {\n    let outOfRange = false;\n    let modDate = getDate(el);\n    if (modDate > endDate || modDate < startDate) {\n        el.parentNode.classList.add(classOutOfRange);\n        for (const input of el.querySelectorAll(\".form-group\").values()) {\n            input.classList.add(classOutOfRange);\n        }\n        outOfRange = true;\n    } else {\n        el.parentNode.classList.remove(classOutOfRange);\n        for (const input of el.querySelectorAll(\".form-group\").values()) {\n            input.classList.remove(classOutOfRange);\n        }\n    }\n    return outOfRange;\n};\n\n/**\n * Change the enabled dates by the amount the start date has been shifted.\n * @returns {Date}\n */\nconst adjustDates = () => {\n    if (!document.getElementById(\"id_movealldates\").checked) {\n        return startDate;\n    }\n    // Determine the change.\n    let newStart = getDate(datetimeSelectors.item(0));\n    let dst1 = startDate.getTimezoneOffset() - newStart.getTimezoneOffset(); // Account for daylight savings shift.\n    let change = newStart - startDate + (dst1 * 60000);\n\n    // Update all enabled dates.\n    for (const date of datetimeSelectors.entries()) {\n        if (date[0] > 0) {\n            let optional = date[1].querySelector(\"input[type='checkbox']\");\n            if (optional === null || optional.checked) {\n                let currDate = getDate(date[1]);\n                let newDate = new Date(currDate.getTime() + change);\n                let dst2 = newDate.getTimezoneOffset() - currDate.getTimezoneOffset();\n                newDate = new Date(newDate.getTime() + (dst2 * 60000));\n                setDate(date[1], newDate);\n            }\n        }\n    }\n\n    // Update the stored value for the end date.\n    let endDateSelector = datetimeSelectors.item(1);\n    let optional = endDateSelector.querySelector(\"input[type='checkbox']\");\n    if (optional.checked) {\n        endDate = getDate(endDateSelector);\n    } else {\n        endDate = new Date(farawayDate);\n    }\n\n    return newStart;\n};\n"],"names":["farawayDate","datetimeSelectors","startDate","endDate","Date","document","querySelectorAll","courseStart","item","courseEnd","getDate","querySelector","checked","addEventListener","startDateChanged","endDateChanged","date","entries","modDateChanged","M","form","dateselector","calendar","on","updateDates","datepicker","currentowner","setTimeout","datetimeSelector","calendarimage","getDOMNode","closest","checkDateRange","adjustDates","checkAllDatesRange","endDateSelector","optional","ev","container","target","dateEl","year","month","day","hour","minute","options","selectedIndex","value","setDate","getFullYear","selected","getMonth","getHours","getMinutes","datesOutOfRange","ModalFactory","create","type","types","DEFAULT","title","body","then","modal","show","el","outOfRange","modDate","parentNode","classList","add","input","values","remove","getElementById","newStart","dst1","getTimezoneOffset","change","currDate","newDate","getTime","dst2"],"mappings":"qoCA0BMA,YAAc,iCAChBC,kBAAoB,GACpBC,UAAY,GACZC,QAAU,IAAIC,KAAKJ,2BAKH,KAEhBC,kBAAoBI,SAASC,iBAAiB,gDAC1CC,YAAcN,kBAAkBO,KAAK,GACrCC,UAAYR,kBAAkBO,KAAK,GACvCN,UAAYQ,QAAQH,aACLE,UAAUE,cAAc,0BAC1BC,UACTT,QAAUO,QAAQD,YAItBF,YAAYM,iBAAiB,SAAUC,kBACvCL,UAAUI,iBAAiB,SAAUE,oBAEhC,MAAMC,QAAQf,kBAAkBgB,UAC7BD,KAAK,GAAK,GACVA,KAAK,GAAGH,iBAAiB,SAAUK,gBAI3CC,EAAEC,KAAKC,aAAaC,SAASC,GAAG,kBAAmBC,aAAa,UAM9DA,YAAc,SACZC,WAAaN,EAAEC,KAAKC,aAAaK,aACjC,OAASD,YAIbE,YACI,eAEQC,iBADKH,WAAWI,cAAcC,aACRC,QAAQ,4CAC9BH,mBAAqB3B,kBAAkBO,KAAK,GAC5CM,mBACOc,mBAAqB3B,kBAAkBO,KAAK,GACnDO,iBAEAiB,eAAeJ,oBAGvB,MAQFd,iBAAmB,KACrBZ,UAAY+B,cACZC,sBAOEnB,eAAiB,SACfoB,gBAAkBlC,kBAAkBO,KAAK,GACzC4B,SAAWD,gBAAgBxB,cAAc,0BAEzCR,QADAiC,SAASxB,QACCF,QAAQyB,iBAER,IAAI/B,KAAKJ,aAEvBkC,sBAQEhB,eAAkBmB,SAEhBC,UAAYD,GAAGE,OAAOR,QAAQ,4CAElCC,eAAeM,YAQb5B,QAAW8B,aACTC,KAAOD,OAAO7B,cAAc,kDAC5B+B,MAAQF,OAAO7B,cAAc,kDAC7BgC,IAAMH,OAAO7B,cAAc,kDAC3BiC,KAAOJ,OAAO7B,cAAc,kDAC5BkC,OAASL,OAAO7B,cAAc,yDAC3B,IAAIP,KACPqC,KAAKK,QAAQL,KAAKM,eAAeC,MACjCN,MAAMI,QAAQJ,MAAMK,eAAeC,MAAQ,EAC3CL,IAAIG,QAAQH,IAAII,eAAeC,MAC/BJ,KAAKE,QAAQF,KAAKG,eAAeC,MACjCH,OAAOC,QAAQD,OAAOE,eAAeC,QASvCC,QAAU,CAACT,OAAQxB,YACjByB,KAAOD,OAAO7B,cAAc,kDAC5B+B,MAAQF,OAAO7B,cAAc,kDAC7BgC,IAAMH,OAAO7B,cAAc,kDAC3BiC,KAAOJ,OAAO7B,cAAc,kDAC5BkC,OAASL,OAAO7B,cAAc,kDAClC8B,KAAK9B,cAAc,WAAaK,KAAKkC,cAAgB,MAAMC,SAAW,WACtET,MAAM/B,cAAc,YAAcK,KAAKoC,WAAa,GAAK,MAAMD,SAAW,WAC1ER,IAAIhC,cAAc,WAAaK,KAAKN,UAAY,MAAMyC,SAAW,WACjEP,KAAKjC,cAAc,WAAaK,KAAKqC,WAAa,MAAMF,SAAW,WACnEN,OAAOlC,cAAc,WAAaK,KAAKsC,aAAe,MAAMH,SAAW,YAOrEjB,mBAAqB,SACnBqB,gBAAkB,MAEjB,MAAMvC,QAAQf,kBAAkBgB,aAC7BD,KAAK,GAAK,EAAG,KACToB,SAAWpB,KAAK,GAAGL,cAAc,2BACpB,OAAbyB,UAAqBA,SAASxB,WAC9B2C,iBAAmBvB,eAAehB,KAAK,YAM/CuC,gBAAkB,GACXC,aAAaC,OAAO,CACvBC,KAAMF,aAAaG,MAAMC,QACzBC,OAAO,mBAAU,wBAAyB,oBAC1CC,MAAM,mBAAU,uBAAwB,sBAEvCC,MAAKC,QACFA,MAAMC,OACCD,UAYjBhC,eAAkBkC,SAChBC,YAAa,EACbC,QAAU1D,QAAQwD,OAClBE,QAAUjE,SAAWiE,QAAUlE,UAAW,CAC1CgE,GAAGG,WAAWC,UAAUC,IA7KR,kBA8KX,MAAMC,SAASN,GAAG5D,iBAAiB,eAAemE,SACnDD,MAAMF,UAAUC,IA/KJ,cAiLhBJ,YAAa,MACV,CACHD,GAAGG,WAAWC,UAAUI,OAnLR,kBAoLX,MAAMF,SAASN,GAAG5D,iBAAiB,eAAemE,SACnDD,MAAMF,UAAUI,OArLJ,qBAwLbP,YAOLlC,YAAc,SACX5B,SAASsE,eAAe,mBAAmB/D,eACrCV,cAGP0E,SAAWlE,QAAQT,kBAAkBO,KAAK,IAC1CqE,KAAO3E,UAAU4E,oBAAsBF,SAASE,oBAChDC,OAASH,SAAW1E,UAAoB,IAAP2E,SAGhC,MAAM7D,QAAQf,kBAAkBgB,aAC7BD,KAAK,GAAK,EAAG,KACToB,SAAWpB,KAAK,GAAGL,cAAc,6BACpB,OAAbyB,UAAqBA,SAASxB,QAAS,KACnCoE,SAAWtE,QAAQM,KAAK,IACxBiE,QAAU,IAAI7E,KAAK4E,SAASE,UAAYH,QACxCI,KAAOF,QAAQH,oBAAsBE,SAASF,oBAClDG,QAAU,IAAI7E,KAAK6E,QAAQC,UAAoB,IAAPC,MACxClC,QAAQjC,KAAK,GAAIiE,cAMzB9C,gBAAkBlC,kBAAkBO,KAAK,GACzC4B,SAAWD,gBAAgBxB,cAAc,iCAEzCR,QADAiC,SAASxB,QACCF,QAAQyB,iBAER,IAAI/B,KAAKJ,aAGhB4E"}